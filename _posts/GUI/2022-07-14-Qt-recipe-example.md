---
layout: post
categories: GUI
tags: [qt, xml, qt-example]
---

### Reference Links

- [Qt Documentation - Recipe Example](<https://doc.qt.io/qt-5/qtxmlpatterns-recipes-example.html>){:target="_blank"}
- [Qt Documentation - text viewer](<https://doc.qt.io/qt-5/qtextedit.html>){:target="_blank"}
- [Qt Documentation - combo box](<https://doc.qt.io/qt-5/qcombobox.html>){:target="_blank"}
- [Qt Documentation - XQuery](<https://doc.qt.io/qt-5/xquery-introduction.html>){:target="_blank"}
- [Qt Documentation - Qt Desinger](<https://doc.qt.io/qt-5/qtdesigner-manual.html>){:target="_blank"}

### Recipes Example

- Using Qt XML Patterns to query XML data loaded from a file.
- This Recipes example shows how to use Qt XML Patterns to query XML data loaded from a file.

#### Introduction

- In this case, the XML data represents a cookbook, *cookbook.xml*, which contains \<cookbook\> as its document element,
  - which in turn contains a sequence of \<recipe\> elements.
- This XML data is searched using queries stored in **XQuery** files (*.xq).

#### The User Interface

- The UI for this example was created using **Qt Desinger**:

![recipes_example]({{"/assets/images/posts/2022-07-14/recipes_exmple.png"}})

- The UI consists of three [group boxes](<https://doc.qt.io/qt-5/qgroupbox.html>){:target="_blank"} arranged vertically.
  - The top one contains
    - a **text viewer** that displays the XML text from the cookbook file.
  - The middle group box contains
    - a **combo box** for choosing the **XQuery** to run and
      - The *.xq* files in the file list above are shown in the combo box menu.
        - Choosing an **XQuery** loads, parses, and runs the selected **XQuery**.
    - a **text viewer** for displaying the text of the selected **XQuery**.
  - The query result is shown in the bottom group box's **text viewer**.

#### Running your own XQueries

- You can write your own **XQuery** files and run them in the example program.
- The file *xmlpatterns/recipes/recipes.qrc* is the resource file for this example.
  - It is used in *main.cpp (Q_INIT_RESOURCE(recipes);)*.
  - It lists the **XQuery** files(*.xq*) that can be selected in the combo box.
  ```qrc
  <!DOCTYPE RCC><RCC version="1.0">
  <qresource>
    <file>files/cookbook.xml</file>
    <file>files/allRecipes.xq</file>
    <file>files/liquidIngredientsInSoup.xq</file>
    <file>files/mushroomSoup.xq</file>
    <file>files/preparationLessThan30.xq</file>
    <file>files/preparationTimes.xq</file>
  </qresource>
  </RCC>
  ```
  - To add your own queries to the example's combo box, store your *.xq* files in the *example/xmlpatterns/recipes/files* directory and add them to **recipes.qrc** as shown above.

#### Code Walk-Through

- The example's main() function creates the standard instance of [QApplication](<https://doc.qt.io/qt-5/qapplication.html>){:target="_blank"}.
  - Then it creates an instance of the UI class, shows it, and starts the Qt event loop:

  ```main.cpp
  int main(int argc, char *argv[])
  {
      Q_INIT_RESOURCE(recipes);
      QApplication app(argc, argv);
      QueryMainWindow* const queryW = new QueryMainWindow;
      queryW->show();
      return app.exec();
  }
  ```

##### The UI Class: QueryMainWindow

- The example's UI is a conventional Qt GUI application inheriting [QMainWindow](<https://doc.qt.io/qt-5/qmainwindow.html>){:target="_blank"} and the class generated by **Qt Designer**:

```querymainwindow.h
class QueryMainWindow : public QMainWindow,
                        private Ui::QueryWidget
{
    Q_OBJECT

public:
    QueryMainWindow();

public slots:
    void displayQuery(int index);

private:
    QComboBox* ui_defaultQueries;

    void evaluate(const QString& str);
    void loadInputFile();
};
```

- The constructor finds the window's **combo box** child widget and connects its [currentIndexChanged](<https://doc.qt.io/qt-5/qcombobox.html#currentIndexChanged>){:target="_blank"}() signal to the window's **dispalyQuery()** slot.
- It then calls **loadInputFile()** to load *cookbook.xml* and
  - display its contents in the top group box's **text viewer**.
- Finally, it finds the **XQuery** files(*.xq*) and adds each one to the **combo box** menu.

```querymainwindow.cpp
QueryMainWindow::QueryMainWindow()	:
    ui_defaultQueries(0)
{
    setupUi(this);

    new XmlSyntaxHighlighter(findChild<QTextEdit*>("inputTextEdit")->document());
    new XmlSyntaxHighlighter(findChild<QTextEdit*>("outputTextEdit")->document());

    ui_defaultQueries = findChild<QComboBox*>("defaultQueries");
    QMetaObject::connectSlotsByName(this);

    // connect(ui_defaultQueries, SIGNAL(currentIndexChanged(int)), SLOT(displayQuery(int)));
    connect(ui_defaultQueries, (QOverload<int>::of(&QComboBox::currentIndexChanged)),
            this, (&QueryMainWindow::displayQuery));

    loadInputFile();
    const QStringList queries(QDir(":/files/", "*.xq").entryList());
    for (const auto& query : queries)
        ui_defaultQueries->addItem(query);
    if (queries.count() > 0)
        displayQuery(0);
}
```

- The work is done in the [displayQuery](<https://doc.qt.io/qt-5/qtxmlpatterns-recipes-example.html#displayquery-slot>){:target="_blank"}() slot and the [evaluate](<https://doc.qt.io/qt-5/qtxmlpatterns-recipes-example.html#evaluate-function>){:target="_blank"}() function it calls, **displayQuery**() loads and displays the selected query file and passes the **XQuery** text to **evaluate**()

```querymainwindow.cpp
void QueryMainWindow::displayQuery(int index)
{
    QFile queryFile(QString(":files/") + ui_defaultQueries->itemText(index));
    queryFile.open(QIODevice::ReadOnly);
    const QString query(QString::fromLatin1(queryFile.readAll()));
    findChild<QTextEdit*>("queryTextEdit")->setPlainText(query);

    evaluate(query);
}
```

- **evaluate()** demonstrates the standard Qt XML Pattern usage pattern.
  - First, an instance of [QXmlQuery](<https://doc.qt.io/qt-5/qxmlquery.html>){:target="_blank"} is created (query).
    - The query's [bindVariable](<https://doc.qt.io/qt-5/qxmlquery.html#bindVariable>){:target="_blank"} function is then called to bind the *cookbook.xml* file to the **XQuery** variable *inputDocument*.
    - *After* the variable is bound, [setQuery](<https://doc.qt.io/qt-5/qxmlquery.html#setQuery>){:target="_blank"}() is called to pass the **XQuery** text to the query.

> Note: **setQuery()** must be called after **bindVariable()**.

- Passing the **XQuery** to **setQuery()** causes Qt XML Patterns to parse the **XQuery**.
  - [QXmlQuery::isValid](<https://doc.qt.io/qt-5/qxmlquery.html#isValid>){:target="_blank"}() is called to ensure that the **XQuery** was correctly parsed.

```querymainwindow.cpp
void QueryMainWindow::evaluate(const QString &str)
{
    QFile sourceDocument;
    sourceDocument.setFileName(":/files/cookbook.xml");
    sourceDocument.open(QIODevice::ReadOnly);

    QByteArray outArray;
    QBuffer buffer(&outArray);
    buffer.open(QIODevice::ReadWrite);

    QXmlQuery query;
    query.bindVariable("inputDocument", &sourceDocument);
    query.setQuery(str);
    if (!query.isValid())
        return;

    QXmlFormatter formatter(query, &buffer);
    if (!query.evaluateTo(&formatter))
        return;

    buffer.close();
    findChild<QTextEdit*>("outputTextEdit")->setPlainText(QString::fromUtf8(outArray.constData()));
}
```

- If the **XQuery** is valid, an instance of [QXmlFormatter](<https://doc.qt.io/qt-5/qxmlformatter.html>){:target="_blank"} is created to format the query result as XML into a [QBuffer](<https://doc.qt.io/qt-5/qbuffer.html>){:target}.
  - To evaluate the **XQuery**, an overload of [evaluateTo](<https://doc.qt.io/qt-5/qxmlquery.html#evaluateTo>){:target="_blank"} is called that takes a [QAbstractXmlReceiver](<https://doc.qt.io/qt-5/qabstractxmlreceiver.html>){:target="_blank"} for its output (**QXmlFormatter** inherits **QAbstractXmlReceiver**).
- Finally, the formatted XML result is displayed in the UI's bottom text view.

> Note: Each **XQuery** *.xq* file must declare the **$inputDocument** variable to represent the *cookbook.xml* document.

```
(: All ingredients for Mushroom Soup. :)
declare variable $inputDocument external;

doc($inputDocument)/cookbook/recipe[@xml:id = "MushroomSoup"]/ingredient/
<p>{@name, @quantity}</p>
```

> Note: if you add your own *query.xq* files, you must declare the $inputDocument and use it as shown above.
